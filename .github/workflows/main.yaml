# -----------------------------
# Workflow name (shown in GitHub Actions UI)
# -----------------------------
name: CI-CD Pipeline

# -----------------------------
# When should this workflow run?
# -----------------------------
on:
  push:
    branches: [main]          # Run only on main branch
    paths-ignore:
      - README.md             # Ignore README-only changes

# -----------------------------
# Permissions for the workflow
# -----------------------------
# NOTE:
# We are using static AWS credentials (access key + secret),
# so OIDC (id-token) is NOT required.
permissions:
  contents: read

# -----------------------------
# Jobs = independent tasks GitHub will run
# -----------------------------
jobs:

  # ============================================================
  # 1. CONTINUOUS INTEGRATION (CI)
  # ============================================================
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Sanity check (FastAPI import)
      - name: Sanity import check
        run: |
          python - <<EOF
          import app
          print("FastAPI import OK")
          EOF

  # ============================================================
  # 2. BUILD & PUSH DOCKER IMAGES (CD - Delivery)
  # ============================================================
  build-and-push:
    name: Build & Push Docker Images
    needs: ci
    runs-on: ubuntu-latest

    # Construct ECR registry URI dynamically
    # Format: <account_id>.dkr.ecr.<region>.amazonaws.com
    env:
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

    steps:
      # Step 1: Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 3: Login Docker to Amazon ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # Step 4: Build & push FastAPI image
      - name: Build & Push API Image
        run: |
          docker build -f api.Dockerfile \
            -t $ECR_REGISTRY/${{ secrets.ECR_API_REPO }}:latest .
          docker push $ECR_REGISTRY/${{ secrets.ECR_API_REPO }}:latest

      # Step 5: Build & push Streamlit image
      - name: Build & Push Streamlit Image
        run: |
          docker build -f streamlit.Dockerfile \
            -t $ECR_REGISTRY/${{ secrets.ECR_UI_REPO }}:latest .
          docker push $ECR_REGISTRY/${{ secrets.ECR_UI_REPO }}:latest

  # ============================================================
  # 3. DEPLOYMENT (Production)
  # ============================================================
  deploy:
    name: Deploy Services
    needs: build-and-push
    runs-on: self-hosted     # EC2 self-hosted runner

    env:
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Configure AWS credentials on EC2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 3: Login Docker to ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # Step 4: Pull latest images from ECR
      - name: Pull latest images
        run: |
          docker pull $ECR_REGISTRY/${{ secrets.ECR_API_REPO }}:latest
          docker pull $ECR_REGISTRY/${{ secrets.ECR_UI_REPO }}:latest

      # Step 5: Stop existing containers (safe even if none exist)
      - name: Stop existing services
        run: docker compose down || true

      # Step 6: Start services using Docker Compose
      # docker-compose.yml should reference images via ${ECR_REGISTRY}
      - name: Start services with Docker Compose
        env:
          ECR_URI: $ECR_REGISTRY
        run: docker compose up -d

      # Step 7: Cleanup unused Docker resources
      - name: Cleanup
        run: docker system prune -f
